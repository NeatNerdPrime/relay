version: 1
name: nebula-workflow-test

variables:
- name: TEST_VAR
  value: nebula-example-1234
- name: GOOGLE_CLOUD_REGION
  value: us-west1

actions:
- name: create-cluster
  kind: gke-cluster-provisioner
  spec:
    name: example-cluster-1
    projectID: $GOOGLE_PROJECT_ID
    region: $GOOGLE_CLOUD_REGION
- name: install-redis
  kind: workflow
  spec:
    import: http://github.com/puppetlabs/nebula-redis-workflow

- name: build
  kind: shell
  spec: 
    commands:
      - make
      - docker build -t $(REGISTRY_HOST):$(REGISTRY_PORT)/$(IMAGE_NAME):$(IMAGE_TAG) .
      
- name: test
  kind: shell
  spec:
    commands:
      - go test ./...

- name: publish
  kind: shell
  spec:
    commands:
      - docker push $(REGISTRY_HOST):$(REGISTRY_PORT)/$(IMAGE_NAME):$(IMAGE_TAG)

stages:
  start_on:
    - action: commit
      branch: master
  steps:
    - build
    - test
    - publish
