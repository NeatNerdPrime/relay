version: 1
name: nebula-plan-test

variables:
- name: TEST_VAR
  value: nebula-example-1234
- name: GOOGLE_CLOUD_REGION
  value: us-west1

actions:
- name: create-cluster
  source: nebula.io/nebula-k8s-runner:latest
  resourceID: nebula-staging-cluster
  spec:
    name: example-cluster-1
    projectID: $GOOGLE_PROJECT_ID
    region: $GOOGLE_CLOUD_REGION

- name: build
  source: nebula.io/nebula-shell-runner:latest
  spec:
    script:
    - make
    - docker build -t $(REGISTRY_HOST):$(REGISTRY_PORT)/$(IMAGE_NAME):$(IMAGE_TAG) .

- name: test
  source: nebula.io/nebula-shell-runner:latest
  spec:
    script:
    - go test ./...

- name: publish
  source: nebula.io/nebula-shell-runner:latest
  spec:
    script:
    - docker push $(REGISTRY_HOST):$(REGISTRY_PORT)/$(IMAGE_NAME):$(IMAGE_TAG)

- name: deploy
  source: nebula.io/nebula-helm-runner:latest
  spec:
    chartPath: helm-chart
    valuesPath: helm-chart/values.yaml
    resourceID: nebula-staging-cluster
    set:
      image.repository: $(IMAGE_NAME)
      image.tag: $(IMAGE_TAG)

workflows:
- name: staging
  trigger:
    on:
    - event: commit
      tag: '^v\d.\d.\d-beta$'
  actions:
  - build
  - test
  - publish
  - deploy
