version: 1
description: A fixture for workflow loading test cases

variables:
- name: TEST_VAR
  value: nebula-example-1234
- name: GOOGLE_CLOUD_REGION
  value: us-west1

steps:
- name: create-cluster
  source: nebula.io/nebula-k8s-runner:latest
  spec:
    name: example-cluster-1
    projectID: $GOOGLE_PROJECT_ID
    region: $GOOGLE_CLOUD_REGION

- name: build
  source: nebula.io/nebula-shell-runner:latest
  spec:
    script:
    - make
    - docker build -t $(REGISTRY_HOST):$(REGISTRY_PORT)/$(IMAGE_NAME):$(IMAGE_TAG) .

- name: test
  source: nebula.io/nebula-shell-runner:latest
  spec:
    script:
    - go test ./...

- name: publish
  source: nebula.io/nebula-shell-runner:latest
  spec:
    script:
    - docker push $(REGISTRY_HOST):$(REGISTRY_PORT)/$(IMAGE_NAME):$(IMAGE_TAG)

- name: deploy
  source: nebula.io/nebula-helm-runner:latest
  spec:
    chartPath: helm-chart
    valuesPath: helm-chart/values.yaml
    set:
      image.repository: $(IMAGE_NAME)
      image.tag: $(IMAGE_TAG)
